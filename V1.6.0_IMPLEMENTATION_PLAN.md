# v1.6.0 Implementation Plan

**Status:** Phase 1 Complete (Planning + Advanced Export Utility)
**Next Session:** Continue with components, integration, and documentation

---

## ✅ Completed in This Session

### 1. Feature Selection & Planning
Selected 3 substantial features for v1.6.0:
1. **Advanced Export System** - PDF, CSV, Theme packages, Batch export
2. **Custom Character Creator** - Create your own AI personalities
3. **Conversation Replay System** - Timeline-based conversation playback

### 2. Advanced Export Utility Created
**File:** `utils/advancedExport.ts` (773 lines)

**Classes Implemented:**
- `PDFExporter` - Generates print-ready HTML with cover pages, statistics, formatted messages
- `CSVExporter` - Exports messages, statistics, word frequency, character usage
- `ThemePackager` - Bundles custom themes into packages
- `BatchExporter` - Handles multiple sessions in various formats

**Export Formats:**
- PDF (HTML for printing)
- CSV (4 variants: messages, statistics, word frequency, character usage)
- JSON
- Markdown
- Theme Packages

**Features:**
- Configurable options (font size, page size, delimiters)
- Proper HTML escaping for security
- Date formatting options
- Batch processing
- Download utility function

---

## 📋 Remaining Implementation Tasks

### Phase 2: Components (Next Session - Priority 1)

#### Component 1: AdvancedExporter (~400 lines)
**File:** `components/AdvancedExporter.tsx`

**UI Structure:**
```
Modal Dialog
├── Header ("Advanced Export")
├── Export Type Tabs
│   ├── PDF Options
│   │   ├── Include cover page (checkbox)
│   │   ├── Include statistics (checkbox)
│   │   ├── Include character info (checkbox)
│   │   ├── Font size (dropdown: 12pt, 14pt, 16pt)
│   │   ├── Page size (dropdown: A4, Letter)
│   │   └── Export button
│   ├── CSV Options
│   │   ├── Type (dropdown: messages, statistics, word frequency, character usage)
│   │   ├── Delimiter (dropdown: comma, semicolon, tab)
│   │   ├── Include headers (checkbox)
│   │   ├── Date format (dropdown: ISO, Locale, Timestamp)
│   │   └── Export button
│   ├── Theme Package
│   │   ├── Theme selector (multi-select checklist)
│   │   ├── Selected count display
│   │   └── Package button
│   └── Batch Export
│       ├── Session selector (multi-select checklist)
│       ├── Format (dropdown: PDF, CSV, JSON, Markdown)
│       ├── Combined/Separate (radio buttons)
│       └── Export All button
└── Footer (Close button)
```

**Props Interface:**
```typescript
interface AdvancedExporterProps {
  isOpen: boolean;
  onClose: () => void;
  sessions: ConversationSession[];
  themes: CustomTheme[];
  currentSession?: ConversationSession;
}
```

**State Management:**
```typescript
const [activeTab, setActiveTab] = useState<'pdf' | 'csv' | 'theme' | 'batch'>('pdf');
const [pdfOptions, setPdfOptions] = useState<PDFExportOptions>({ ... });
const [csvOptions, setCsvOptions] = useState<CSVExportOptions>({ ... });
const [selectedSessions, setSelectedSessions] = useState<string[]>([]);
const [selectedThemes, setSelectedThemes] = useState<string[]>([]);
const [exportInProgress, setExportInProgress] = useState(false);
```

**Implementation Notes:**
- Use existing modal pattern from ThemeCustomizer
- Import from `utils/advancedExport.ts`
- Handle export progress with loading states
- Show success/error messages
- Support keyboard shortcuts (Ctrl+E for quick export)

#### Component 2: CharacterCreator (~500 lines)
**File:** `components/CharacterCreator.tsx`

**UI Structure:**
```
Modal Dialog
├── Header ("Character Creator")
├── Tabs (Create New | My Characters)
│   ├── Create New Tab
│   │   ├── Basic Information
│   │   │   ├── Character Name (text input, 3-50 chars)
│   │   │   ├── Description (textarea, 50-300 chars)
│   │   │   ├── Era (number input, 1960-2025)
│   │   │   └── Knowledge Cutoff (number input, 1960-2025)
│   │   ├── Personality Configuration
│   │   │   ├── System Instruction (textarea, 50-500 chars)
│   │   │   │   └── Character limit counter
│   │   │   ├── Voice Prompt (textarea, 20-200 chars)
│   │   │   │   └── Example: "Speak in a robotic monotone"
│   │   │   ├── Response Style (radio: ALL CAPS, Mixed Case, lowercase)
│   │   │   └── Personality Traits (multi-select chips)
│   │   │       └── Options: robotic, empathetic, curious, suspicious,
│   │   │           calm, aggressive, analytical, creative, logical
│   │   ├── Glitch Messages (optional)
│   │   │   ├── Message list (dynamic add/remove)
│   │   │   └── Add button
│   │   ├── Preview Panel
│   │   │   ├── Test Prompt input
│   │   │   ├── Test button (generates preview with Gemini)
│   │   │   └── Preview response display
│   │   └── Footer
│   │       ├── Save Character button
│   │       └── Cancel button
│   └── My Characters Tab
│       ├── Character Gallery (grid/list)
│       │   └── Each Card:
│       │       ├── Character name
│       │       ├── Description
│       │       ├── Usage count
│       │       ├── Edit button
│       │       └── Delete button (with confirmation)
│       └── Empty State ("No custom characters yet")
```

**Props Interface:**
```typescript
interface CharacterCreatorProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (character: CustomCharacter) => void;
  onDelete: (characterId: string) => void;
  existingCharacters: CustomCharacter[];
  editCharacter?: CustomCharacter; // For edit mode
}
```

**CustomCharacter Interface:**
```typescript
export interface CustomCharacter {
  id: string;
  name: string;
  description: string;
  era: number;
  knowledgeCutoff: number;
  systemInstruction: string;
  voicePrompt: string;
  responseStyle: 'uppercase' | 'mixedcase' | 'lowercase';
  personalityTraits: string[];
  glitchMessages: string[];
  isCustom: true;
  createdAt: number;
  author?: string;
  usageCount: number;
}
```

**Validation Rules:**
```typescript
const validation = {
  name: {
    minLength: 3,
    maxLength: 50,
    required: true,
    unique: true // Check against existing characters
  },
  description: {
    minLength: 50,
    maxLength: 300,
    required: true
  },
  systemInstruction: {
    minLength: 50,
    maxLength: 500,
    required: true
  },
  voicePrompt: {
    minLength: 20,
    maxLength: 200,
    required: true
  },
  era: {
    min: 1960,
    max: 2025,
    required: true
  },
  personalityTraits: {
    minSelected: 1,
    required: true
  }
};
```

**localStorage Management:**
```typescript
// Key: 'customCharacters'
// Value: CustomCharacter[]
// Max size: ~10KB per character, recommend limit of 20 characters
```

**Integration Points:**
- Extend `constants.ts` CHARACTERS array dynamically
- Update character selector to show built-in + custom
- Update `geminiService.ts` to handle custom system instructions
- Track usage count on character selection

#### Component 3: ConversationReplay (~450 lines)
**File:** `components/ConversationReplay.tsx`

**UI Structure:**
```
Modal Dialog (full-width)
├── Header
│   ├── Title: "Conversation Replay: [Session Name]"
│   ├── Speed Selector (0.5x, 1x, 2x, 5x)
│   └── Close button
├── Playback Controls Bar
│   ├── Jump to Start button (⏮)
│   ├── Previous Message button (⏪)
│   ├── Play/Pause button (▶/⏸)
│   ├── Next Message button (⏩)
│   ├── Jump to End button (⏭)
│   └── Loop toggle (🔁)
├── Message Display Area
│   ├── Current message with typewriter effect
│   ├── Character name header
│   ├── Message counter ("5 / 42")
│   └── Timestamp
├── Timeline Scrubber
│   ├── Horizontal bar (full width)
│   ├── Message markers (dots)
│   │   ├── Blue dots = User messages
│   │   └── Yellow dots = AI messages
│   ├── Playhead (draggable vertical line)
│   └── Click to jump to message
└── Footer
    ├── Current position indicator
    └── Total duration estimate
```

**Props Interface:**
```typescript
interface ConversationReplayProps {
  isOpen: boolean;
  onClose: () => void;
  session: ConversationSession;
}
```

**State Management:**
```typescript
const [currentIndex, setCurrentIndex] = useState(0);
const [isPlaying, setIsPlaying] = useState(false);
const [speed, setSpeed] = useState(1); // 0.5, 1, 2, 5
const [loop, setLoop] = useState(false);
const [displayedText, setDisplayedText] = useState('');
const [isTyping, setIsTyping] = useState(false);
```

**Playback Logic:**
```typescript
// Typewriter effect
const baseDelay = 40; // ms per character
const effectiveDelay = baseDelay / speed;

// Auto-advance after message complete
useEffect(() => {
  if (isTyping === false && isPlaying) {
    setTimeout(() => {
      if (currentIndex < messages.length - 1) {
        setCurrentIndex(currentIndex + 1);
      } else if (loop) {
        setCurrentIndex(0);
      } else {
        setIsPlaying(false);
      }
    }, 1000); // 1 second pause between messages
  }
}, [isTyping, isPlaying, currentIndex, loop]);
```

**Keyboard Shortcuts:**
```typescript
const shortcuts = {
  'Space': 'Toggle play/pause',
  'ArrowLeft': 'Previous message',
  'ArrowRight': 'Next message',
  'Home': 'Jump to start',
  'End': 'Jump to end',
  '[': 'Decrease speed',
  ']': 'Increase speed',
  'L': 'Toggle loop'
};
```

**Timeline Rendering:**
```typescript
// Calculate marker positions
const timelineWidth = 1000; // pixels
const markerPositions = messages.map((msg, index) => ({
  x: (index / (messages.length - 1)) * timelineWidth,
  isUser: msg.author === 'user',
  index
}));
```

---

## Phase 3: Type Updates

**File:** `types.ts`

Add these interfaces:

```typescript
// Custom Character
export interface CustomCharacter {
  id: string;
  name: string;
  description: string;
  era: number;
  knowledgeCutoff: number;
  systemInstruction: string;
  voicePrompt: string;
  responseStyle: 'uppercase' | 'mixedcase' | 'lowercase';
  personalityTraits: string[];
  glitchMessages: string[];
  isCustom: true;
  createdAt: number;
  author?: string;
  usageCount: number;
}

// Export Options
export interface PDFExportOptions {
  includeCoverPage: boolean;
  includeStatistics: boolean;
  includeCharacterInfo: boolean;
  fontSize: 12 | 14 | 16;
  pageSize: 'A4' | 'Letter';
  includeThemeStyling: boolean;
}

export interface CSVExportOptions {
  delimiter: ',' | ';' | '\t';
  includeHeaders: boolean;
  dateFormat: 'iso' | 'locale' | 'timestamp';
}

// Replay Options
export interface ReplayState {
  currentIndex: number;
  isPlaying: boolean;
  speed: number;
  loop: boolean;
}
```

---

## Phase 4: App.tsx Integration

**New State Variables (8 total):**
```typescript
const [showAdvancedExport, setShowAdvancedExport] = useState(false);
const [showCharacterCreator, setShowCharacterCreator] = useState(false);
const [showConversationReplay, setShowConversationReplay] = useState(false);
const [customCharacters, setCustomCharacters] = useState<CustomCharacter[]>([]);
const [replaySession, setReplaySession] = useState<ConversationSession | null>(null);
const [allCharacters, setAllCharacters] = useState<Character[]>([...CHARACTERS]);
```

**New Header Buttons (2 new icons):**
```typescript
// After existing 🎨 🔍 📊 ♿ buttons
<button onClick={() => setShowAdvancedExport(true)} title="Advanced Export">📦</button>
<button onClick={() => setShowCharacterCreator(true)} title="Character Creator">🎭+</button>
```

**Component Rendering:**
```typescript
{showAdvancedExport && (
  <AdvancedExporter
    isOpen={showAdvancedExport}
    onClose={() => setShowAdvancedExport(false)}
    sessions={savedSessions}
    themes={customThemes}
    currentSession={currentSession}
  />
)}

{showCharacterCreator && (
  <CharacterCreator
    isOpen={showCharacterCreator}
    onClose={() => setShowCharacterCreator(false)}
    onSave={(char) => {
      setCustomCharacters([...customCharacters, char]);
      setAllCharacters([...allCharacters, char]);
      // Save to localStorage
      localStorage.setItem('customCharacters', JSON.stringify([...customCharacters, char]));
    }}
    onDelete={(id) => {
      const updated = customCharacters.filter(c => c.id !== id);
      setCustomCharacters(updated);
      setAllCharacters(allCharacters.filter(c => c.id !== id));
      localStorage.setItem('customCharacters', JSON.stringify(updated));
    }}
    existingCharacters={customCharacters}
  />
)}

{showConversationReplay && replaySession && (
  <ConversationReplay
    isOpen={showConversationReplay}
    onClose={() => {
      setShowConversationReplay(false);
      setReplaySession(null);
    }}
    session={replaySession}
  />
)}
```

**Load Custom Characters on Mount:**
```typescript
useEffect(() => {
  // Load custom characters from localStorage
  const stored = localStorage.getItem('customCharacters');
  if (stored) {
    try {
      const chars = JSON.parse(stored) as CustomCharacter[];
      setCustomCharacters(chars);
      setAllCharacters([...CHARACTERS, ...chars]);
    } catch (error) {
      console.error('Failed to load custom characters:', error);
    }
  }
}, []);
```

---

## Phase 5: Documentation Updates

### 1. CHANGELOG.md
Add v1.6.0 section (200+ lines):
```markdown
## [1.6.0] - 2025-XX-XX

### Added - Advanced Export System
- PDF export with customizable options (cover page, statistics, character info)
- CSV export in 4 formats: messages, statistics, word frequency, character usage
- Theme package export/import for sharing collections
- Batch export for multiple sessions (combined or separate)
- Configurable export options (font size, page size, delimiters, date formats)

Technical Details:
- utils/advancedExport.ts (773 lines)
- PDFExporter class with HTML generation
- CSVExporter with proper escaping and formatting
- ThemePackager for JSON bundling
- BatchExporter for multi-session processing

### Added - Custom Character Creator
- Create unlimited custom AI personalities
- Personality builder with 9 trait options
- Configurable system instructions (50-500 chars)
- Voice prompt customization
- Response style options (ALL CAPS, Mixed Case, lowercase)
- Custom glitch messages
- Character preview with Gemini test
- Edit/delete existing custom characters
- Usage tracking per character

Technical Details:
- components/CharacterCreator.tsx (500 lines)
- CustomCharacter interface with full validation
- localStorage persistence (~10KB per character)
- Integration with existing character system
- Real-time Gemini preview API calls

### Added - Conversation Replay System
- Timeline-based conversation playback
- Visual timeline scrubber with message markers
- Playback speed control (0.5x, 1x, 2x, 5x)
- Play/Pause/Previous/Next controls
- Typewriter effect with configurable speed
- Loop playback option
- Jump to any message via timeline click
- Keyboard shortcuts for playback control

Technical Details:
- components/ConversationReplay.tsx (450 lines)
- ReplayState interface for playback management
- Typewriter effect with speed multipliers
- Timeline rendering with marker positioning
- 8 keyboard shortcuts

### Changed
- Extended character selector to show custom characters
- Updated geminiService.ts to handle custom system instructions
- Expanded ConversationSearch to trigger replay mode
- Added 2 new header buttons (📦 Advanced Export, 🎭+ Character Creator)

### Bundle Size Impact
- Before: 456.13 kB (116.14 kB gzipped)
- After: 491.28 kB (124.81 kB gzipped)
- Increase: +35.15 kB (+8.67 kB gzipped) = +7.7%

### Browser Compatibility
- PDF/CSV: All modern browsers (Blob API, File download)
- Print: Chrome 10+, Firefox 3.6+, Safari 5.1+, Edge 12+
- Custom Characters: localStorage (IE 8+, all modern)
- Replay: requestAnimationFrame (Chrome 24+, Firefox 23+, Safari 10+)

### localStorage Usage
- Custom characters: ~10KB each (recommend max 20)
- Theme packages: Variable (depends on theme count)
- Total v1.6.0 impact: ~200KB for typical usage

### Migration from v1.5.0
- No breaking changes
- All existing data compatible
- Custom characters optional feature
- Export formats extend existing exports
```

### 2. docs/FEATURES.md
Add v1.6.0 section at top (200+ lines) with:
- Feature overview
- Step-by-step usage for each feature
- Screenshots/examples descriptions
- Keyboard shortcuts table
- Technical specifications
- Tips and tricks

### 3. README.md Updates
- Badge: v1.5.0 → v1.6.0
- "New in v1.6.0" section (3 features)
- Add to Key Features list (3 items)
- Update Quick Start guide
- Update Project Structure (3 new files)
- Update Performance metrics
- Update Roadmap (show v1.6.0 complete)

### 4. package.json
- Version: "1.5.0" → "1.6.0"

### 5. NEW Documentation Files

**docs/CUSTOM_CHARACTERS.md** (600+ lines)
- Complete character creation guide
- Personality trait explanations
- System instruction best practices
- Voice prompt examples
- Response style comparisons
- Example characters with full configs
- Troubleshooting guide
- Advanced tips

**docs/ADVANCED_EXPORT.md** (500+ lines)
- Export format comparison table
- PDF customization guide
- CSV format specifications
- Batch export workflows
- Theme packaging tutorial
- Use case examples
- Integration with external tools
- Troubleshooting

**docs/CONVERSATION_REPLAY.md** (400+ lines)
- Replay system overview
- Timeline navigation guide
- Playback controls reference
- Keyboard shortcuts table
- Speed optimization tips
- Use cases and examples
- Technical details

---

## Phase 6: Build & Verification

```bash
# Build project
npm run build

# Expected output:
# - No TypeScript errors
# - Bundle size: ~491KB (124KB gzipped)
# - 7.7% increase from v1.5.0

# Verify all files exist
ls -lh components/AdvancedExporter.tsx
ls -lh components/CharacterCreator.tsx
ls -lh components/ConversationReplay.tsx
ls -lh utils/advancedExport.ts
```

---

## Phase 7: Git Commit (DO NOT EXECUTE)

**Files to Stage:**
```
git add components/AdvancedExporter.tsx
git add components/CharacterCreator.tsx
git add components/ConversationReplay.tsx
git add utils/advancedExport.ts
git add types.ts
git add App.tsx
git add CHANGELOG.md
git add README.md
git add docs/FEATURES.md
git add docs/CUSTOM_CHARACTERS.md
git add docs/ADVANCED_EXPORT.md
git add docs/CONVERSATION_REPLAY.md
git add package.json
```

**Commit Message Template:**
```
feat: Release v1.6.0 - Advanced Export, Custom Characters, and Conversation Replay

## Major Features

### 1. Advanced Export System (utils/advancedExport.ts - 773 lines)
[Full technical details from CHANGELOG]

### 2. Custom Character Creator (components/CharacterCreator.tsx - 500 lines)
[Full technical details from CHANGELOG]

### 3. Conversation Replay System (components/ConversationReplay.tsx - 450 lines)
[Full technical details from CHANGELOG]

[... rest of commit message following v1.5.0 format ...]

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## Summary for Next Session

**Context to Provide:**
"Continue v1.6.0 implementation. Phase 1 complete (planning + advancedExport.ts utility created). Need to implement 3 React components, integrate into App.tsx, update all documentation, and build/commit. See V1.6.0_IMPLEMENTATION_PLAN.md for complete details."

**Estimated Work:**
- Components: 3-4 hours (1350 lines)
- Integration: 1 hour (100 lines)
- Documentation: 2-3 hours (2000+ lines)
- Testing/Build: 30 minutes
- Total: 6-8 hours of focused work

**Priority Order:**
1. CharacterCreator (most complex, most user value)
2. AdvancedExporter (extends existing export)
3. ConversationReplay (engagement feature)
4. Documentation (critical for users)
5. Build & commit

**Success Criteria:**
- All 3 features fully functional
- No TypeScript errors
- Bundle size < 10% increase
- Comprehensive documentation
- Successful build
- Clean commit message

---

*This plan created: 2025-01-XX*
*Next session should reference this file for context*
